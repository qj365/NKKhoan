@model NKKhoan.Areas.Admin.ViewModels.TaskViewModel

@{
    ViewBag.Title = "Index";
    Layout = "~/Areas/Admin/Views/Shared/_Layout.cshtml";
    string ca;
    if (Model.nkslk.GioBatDau == new TimeSpan(6, 0, 0) && Model.nkslk.GioKetThuc == new TimeSpan(14, 0, 0))
    {
        ca = "ca 1 (6h-14h)";
    }
    else if (Model.nkslk.GioBatDau == new TimeSpan(14, 0, 0) && Model.nkslk.GioKetThuc == new TimeSpan(22, 0, 0))
    {
        ca = "ca 2 (14h-22h)";
    }
    else if (Model.nkslk.GioBatDau == new TimeSpan(22, 0, 0) && Model.nkslk.GioKetThuc == new TimeSpan(6, 0, 0))
    {
        ca = "ca 3 (22h-6h)";
    }
    else
    {
        ca = Model.nkslk.GioBatDau.ToString() + "-" + Model.nkslk.GioKetThuc.ToString();
    }
}

<section class="content-header">
    <div class="container-fluid">
        <div class="row mb-2">
            <div class="col-sm-10">
                <h1>Thông tin khoán ngày @Model.nkslk.NgayThucHienKhoan.ToString("dd-MM-yyyy"), @ca</h1>
            </div>

        </div>
    </div><!-- /.container-fluid -->
</section>

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="col-sm-12">
                            <div class="col-sm-6">
                                <h1>Công nhân</h1>
                            </div>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <table id="example1" class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congnhan.FirstOrDefault().HoTen)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congnhan.FirstOrDefault().NgayNamSinh)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congnhan.FirstOrDefault().GioiTinh)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congnhan.FirstOrDefault().QueQuan)
                                    </th>
                                    <th>
                                        @Html.DisplayName("Phòng ban")
                                    </th>
                                    <th>
                                        @Html.DisplayName("Chức vụ")
                                    </th>
                                    <th>
                                        @Html.DisplayName("Giờ bắt đầu làm")
                                    </th>
                                    <th>
                                        @Html.DisplayName("Giờ kết thúc làm")
                                    </th>
                                    <th>Chức năng</th>
                                </tr>
                            </thead>

                            @foreach (var item in Model.congnhan)
                            {
                                string title = string.Empty;
                                string styleWarning = string.Empty;
                                TimeSpan? giobatdau = item.ChiTietNhanCongKhoan.SingleOrDefault(x => (x.CongNhan.MaNhanCong == item.MaNhanCong && x.MaNKSLK == Model.nkslk.MaNKSLK)).GioBatDau;
                                TimeSpan? gioketthuc = item.ChiTietNhanCongKhoan.SingleOrDefault(x => (x.CongNhan.MaNhanCong == item.MaNhanCong && x.MaNKSLK == Model.nkslk.MaNKSLK)).GioKetThuc;
                                if (giobatdau > Model.nkslk.GioBatDau && gioketthuc < Model.nkslk.GioKetThuc && giobatdau != null && gioketthuc != null)
                                {
                                    title = "Công nhân này đến muộn và về sớm";
                                }
                                else if (giobatdau > Model.nkslk.GioBatDau)
                                {
                                    title = "Công nhân này đến muộn";
                                }
                                else if (gioketthuc < Model.nkslk.GioKetThuc)
                                {
                                    title = "Công nhân này về sớm";
                                }
                                else
                                {
                                    styleWarning = "display:none";
                                }
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.HoTen)
                                <i class="fas fa-exclamation-circle warning-user" data-toggle="tooltip" data-placement="right" title="@title" style=@styleWarning></i>
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.NgayNamSinh)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.GioiTinh)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.QueQuan)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.PhongBan.TenPhongBan)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.ChucVu.TenChucVu)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => Model.nkslk.ChiTietNhanCongKhoan.SingleOrDefault(x => x.CongNhan.MaNhanCong == item.MaNhanCong).GioBatDau)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => Model.nkslk.ChiTietNhanCongKhoan.SingleOrDefault(x => x.CongNhan.MaNhanCong == item.MaNhanCong).GioKetThuc)
                            </td>
                            <td>

                                <a class="btn-edit" href="~/Admin/Task/EditEmployee/?employee=@item.MaNhanCong&task=@Model.nkslk.MaNKSLK">
                                    <i class="far fa-edit icon-edit"></i>
                                </a>

                                <a class="js-delete" href="~/Admin/Task/DeleteEmployee/?employee=@item.MaNhanCong&task=@Model.nkslk.MaNKSLK">
                                    <i class="far fa-trash-alt icon-delete" style="margin-right: 10px"></i>
                                </a>
                            </td>
                        </tr>
                            }
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="col-sm-12">
                            <div class="col-sm-6">
                                <h1>Công việc</h1>
                            </div>
                        </div>
                    </div>
                    <!-- /.card-header -->
                    <div class="card-body">
                        <table id="example2" class="table table-bordered table-hover">
                            <thead>
                                <tr>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congviec.FirstOrDefault().TenCongViec)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congviec.FirstOrDefault().DinhMucKhoan)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congviec.FirstOrDefault().DonViKhoan)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congviec.FirstOrDefault().HeSoKhoan)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congviec.FirstOrDefault().DinhMucLaoDong)
                                    </th>
                                    <th>
                                        @Html.DisplayNameFor(model => model.congviec.FirstOrDefault().DonGia)
                                    </th>
                                    <th>
                                        @Html.DisplayName("Sản phẩm")
                                    </th>
                                    <th>
                                        @Html.DisplayName("Sản lượng")
                                    </th>
                                    <th>Chức năng</th>
                                </tr>
                            </thead>

                            @foreach (var item in Model.congviec)
                            {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.TenCongViec)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.DinhMucKhoan)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.DonViKhoan)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.HeSoKhoan)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.DinhMucLaoDong)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.DonGia)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.SanPham.TenSanPham)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => Model.nkslk.ChiTietCongViec.SingleOrDefault(x => x.CongViec.MaCongViec == item.MaCongViec).SanLuongThucTe)
                            </td>
                            <td>

                                <a class="btn-edit" href="~/Admin/Task/EditJob/?job=@item.MaCongViec&task=@Model.nkslk.MaNKSLK">
                                    <i class="far fa-edit icon-edit"></i>
                                </a>

                                <a class="js-delete" href="~/Admin/Task/DeleteJob/?job=@item.MaCongViec&task=@Model.nkslk.MaNKSLK">
                                    <i class="far fa-trash-alt icon-delete" style="margin-right: 10px"></i>
                                </a>
                            </td>
                        </tr>
                            }
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<div class="form-group">
    <div class="col-md-offset-1 col-md-11">
        <a href="~/Admin/Task" class="btn btn-warning float-right">Trở về</a>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootbox.js/4.4.0/bootbox.min.js"></script>
<script>
    $(function () {
        $("#example1").DataTable({
            "responsive": true, "lengthChange": false, "autoWidth": false,
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"],
        }).buttons().container().appendTo('#example1_wrapper .col-md-6:eq(0)');

        $("#example1").on("click", ".js-delete", function (event) {
            var button = $(this);

            event.preventDefault();

            bootbox.confirm("Bạn chắc chắn muốn xoá công nhân khoán này?", function (r) {
                if (r) {
                    window.location = button.attr('href');
                }
            })
        });
        if (document.location.search.length) {
            var urlParams = new URLSearchParams(document.location.search);
            $('#Select').val(urlParams.get('Select'));
        }
    });
</script>

<script>
    $(function () {
        $("#example2").DataTable({
            "responsive": true, "lengthChange": false, "autoWidth": false,
            "buttons": ["copy", "csv", "excel", "pdf", "print", "colvis"]
        }).buttons().container().appendTo('#example2_wrapper .col-md-6:eq(0)');

        $("#example2").on("click", ".js-delete", function (event) {
            var button = $(this);

            event.preventDefault();

            bootbox.confirm("Bạn chắc chắn muốn xoá công việc khoán này?", function (r) {
                if (r) {
                    window.location = button.attr('href');
                }
            })
        });
        if (document.location.search.length) {
            var urlParams = new URLSearchParams(document.location.search);
            $('#Select').val(urlParams.get('Select'));
        }
    });
</script>

